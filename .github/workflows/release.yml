name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
          - os: windows-latest
            target: win-x64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: node scripts/bundle-cli.mjs

      # Package the CLI bundle + better-sqlite3 native addon + Node.js runtime
      # into a single self-extracting executable via warp-packer
      - name: Create distribution
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DIST_DIR="archguard-dist"
          mkdir -p "$DIST_DIR"

          # Copy the bundled CLI
          cp packages/cli/dist/archguard.cjs "$DIST_DIR/"

          # Create a minimal package.json for npm install of native deps
          cat > "$DIST_DIR/package.json" << EOF
          {
            "name": "archguard-standalone",
            "version": "${VERSION}",
            "private": true,
            "dependencies": {
              "better-sqlite3": "^11.7.0"
            }
          }
          EOF

          # Install native deps for this platform
          cd "$DIST_DIR"
          npm install --omit=dev --ignore-scripts=false
          cd ..

          # Bundle the Node.js runtime so users don't need it installed
          NODE_DIR="$DIST_DIR/node"
          mkdir -p "$NODE_DIR"
          if [[ "${{ matrix.target }}" == "win-x64" ]]; then
            cp "$(which node).exe" "$NODE_DIR/node.exe" 2>/dev/null || cp "$(which node)" "$NODE_DIR/node.exe"
            # Launcher script
            cat > "$DIST_DIR/archguard.cmd" << 'BATCH'
          @echo off
          "%~dp0node\node.exe" "%~dp0archguard.cjs" %*
          BATCH
            EXEC_NAME="archguard.cmd"
          else
            cp "$(which node)" "$NODE_DIR/node"
            chmod +x "$NODE_DIR/node"
            # Launcher script
            cat > "$DIST_DIR/archguard" << 'SH'
          #!/bin/sh
          exec "$(dirname "$0")/node/node" "$(dirname "$0")/archguard.cjs" "$@"
          SH
            chmod +x "$DIST_DIR/archguard"
            EXEC_NAME="archguard"
          fi

      - name: Download warp-packer
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == "win-x64" ]]; then
            curl -Lo warp-packer.exe https://github.com/dgiagio/warp/releases/download/v0.3.0/windows-x64.warp-packer.exe
            PACKER="./warp-packer.exe"
          else
            curl -Lo warp-packer https://github.com/dgiagio/warp/releases/download/v0.3.0/linux-x64.warp-packer
            chmod +x warp-packer
            PACKER="./warp-packer"
          fi
          echo "PACKER=$PACKER" >> "$GITHUB_ENV"

      - name: Create executable
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [[ "${{ matrix.target }}" == "win-x64" ]]; then
            $PACKER --arch windows-x64 --input_dir archguard-dist --exec archguard.cmd --output "archguard-${VERSION}-win-x64.exe"
          else
            $PACKER --arch linux-x64 --input_dir archguard-dist --exec archguard --output "archguard-${VERSION}-linux-x64"
            chmod +x "archguard-${VERSION}-linux-x64"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: archguard-${{ matrix.target }}
          path: archguard-*-${{ matrix.target }}*

  publish-npm:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: node scripts/bundle-cli.mjs

      - name: Prepare npm package
        run: |
          mkdir -p .publish/dist
          cp packages/cli/dist/archguard.cjs .publish/dist/
          cp packages/cli/package.npm.json .publish/package.json
          cp README.md .publish/
          cp LICENSE .publish/

      - name: Publish to npm
        run: |
          cd .publish
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: archguard-linux-x64

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: archguard-win-x64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            archguard-*-linux-x64
            archguard-*-win-x64.exe
