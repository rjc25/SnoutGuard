name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            archive: tar.gz
          - os: windows-latest
            target: win-x64
            archive: zip
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: node scripts/bundle-cli.mjs

      # Package the CLI bundle + better-sqlite3 native addon
      - name: Create distribution
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DIST_DIR="archguard-${VERSION}-${{ matrix.target }}"
          mkdir -p "$DIST_DIR"

          # Copy the bundled CLI
          cp packages/cli/dist/archguard.cjs "$DIST_DIR/"

          # Create a minimal package.json for npm install of native deps
          cat > "$DIST_DIR/package.json" << EOF
          {
            "name": "archguard-standalone",
            "version": "${VERSION}",
            "private": true,
            "dependencies": {
              "better-sqlite3": "^11.7.0"
            }
          }
          EOF

          # Install native deps for this platform
          cd "$DIST_DIR"
          npm install --omit=dev --ignore-scripts=false
          cd ..

          # Create launcher script
          if [[ "${{ matrix.target }}" == "win-x64" ]]; then
            cat > "$DIST_DIR/archguard.cmd" << 'BATCH'
          @echo off
          node "%~dp0archguard.cjs" %*
          BATCH
          else
            cat > "$DIST_DIR/archguard" << 'SH'
          #!/bin/sh
          exec node "$(dirname "$0")/archguard.cjs" "$@"
          SH
            chmod +x "$DIST_DIR/archguard"
          fi

          # Create archive
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            7z a "archguard-${VERSION}-${{ matrix.target }}.zip" "$DIST_DIR"
          else
            tar czf "archguard-${VERSION}-${{ matrix.target }}.tar.gz" "$DIST_DIR"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: archguard-${{ matrix.target }}
          path: archguard-*.${{ matrix.archive }}

  publish-npm:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: node scripts/bundle-cli.mjs

      - name: Prepare npm package
        run: |
          mkdir -p .publish/dist
          cp packages/cli/dist/archguard.cjs .publish/dist/
          cp packages/cli/package.npm.json .publish/package.json
          cp README.md .publish/
          cp LICENSE .publish/

      - name: Publish to npm
        run: |
          cd .publish
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: archguard-linux-x64

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: archguard-win-x64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            archguard-*.tar.gz
            archguard-*.zip
